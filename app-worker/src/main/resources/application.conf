# Document Pipeline Worker Configuration
# Uses HOCON format with environment variable substitution

# PostgreSQL database configuration
database {
    jdbcUrl = "jdbc:postgresql://localhost:5432/document_pipeline"
    jdbcUrl = ${?DATABASE_URL}
    username = "pipeline"
    username = ${?DATABASE_USERNAME}
    password = "pipeline_secret"
    password = ${?DATABASE_PASSWORD}
    maxPoolSize = 5
    maxPoolSize = ${?DATABASE_MAX_POOL_SIZE}
}

# RabbitMQ configuration
rabbitmq {
    host = "localhost"
    host = ${?RABBITMQ_HOST}
    port = 5672
    port = ${?RABBITMQ_PORT}
    username = "guest"
    username = ${?RABBITMQ_USERNAME}
    password = "guest"
    password = ${?RABBITMQ_PASSWORD}
    virtualHost = "/"
    virtualHost = ${?RABBITMQ_VHOST}

    # Publish retry with exponential backoff
    publish {
        maxRetries = 3
        maxRetries = ${?RABBITMQ_PUBLISH_MAX_RETRIES}
        baseDelayMs = 500
        baseDelayMs = ${?RABBITMQ_PUBLISH_BASE_DELAY_MS}
        maxDelayMs = 10000
        maxDelayMs = ${?RABBITMQ_PUBLISH_MAX_DELAY_MS}
    }

    # Dead letter queue reprocessing
    dlq {
        enabled = true
        enabled = ${?DLQ_REPROCESSOR_ENABLED}
        maxRetryCycles = 3
        maxRetryCycles = ${?DLQ_MAX_RETRY_CYCLES}
        baseDelayMs = 5000
        baseDelayMs = ${?DLQ_BASE_DELAY_MS}
        maxDelayMs = 60000
        maxDelayMs = ${?DLQ_MAX_DELAY_MS}
    }
}

# File storage configuration (for reading files)
storage {
    baseDir = "./document-storage"
    baseDir = ${?STORAGE_BASE_DIR}
}

# ML Classification service
mlService {
    baseUrl = "http://localhost:8000"
    baseUrl = ${?ML_SERVICE_URL}
    timeoutMs = 300000
    timeoutMs = ${?ML_SERVICE_TIMEOUT_MS}

    # Circuit breaker protecting against ML service outages
    circuitBreaker {
        failureThreshold = 5
        failureThreshold = ${?ML_CB_FAILURE_THRESHOLD}
        openDurationMs = 30000
        openDurationMs = ${?ML_CB_OPEN_DURATION_MS}
        halfOpenMaxAttempts = 1
        halfOpenMaxAttempts = ${?ML_CB_HALF_OPEN_MAX_ATTEMPTS}
    }
}

# Metrics
metrics {
    port = 8081
    port = ${?WORKER_METRICS_PORT}
}

# Logging
logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
}
