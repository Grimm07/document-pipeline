# git-cliff ~ configuration file
# https://git-cliff.org/docs/configuration

[changelog]
# changelog header
header = """
# Changelog

All notable changes to this project will be documented in this file.

"""
# A Tera template to be rendered for each release in the changelog.
body = """
{%- if version %}
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{%- else %}
    ## [Unreleased]
{%- endif %}
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {% for commit in commits %}
        - {% if commit.scope %}**{{ commit.scope }}:** {% endif %}\
            {{ commit.message | upper_first }} \
            ([{{ commit.id | truncate(length=7, end="") }}](<REPO>/commit/{{ commit.id }}))\
    {% endfor %}
{% endfor %}
"""
# changelog footer
footer = """
<!-- generated by git-cliff -->
"""
# Remove leading and trailing whitespaces from the changelog's body.
trim = true
# Render body even when there are no releases to process.
render_always = true
# Postprocessors to replace repo placeholder with actual URL.
postprocessors = [
    # Safety net: strip any Claude session links that survive preprocessing.
    { pattern = '\s*https://claude\.ai/\S+', replace = "" },
    # Replace repo placeholder with actual GitHub URL.
    # MUST be last — other patterns use <REPO> as a placeholder.
    { pattern = '<REPO>', replace = "https://github.com/Grimm07/document-pipeline" },
]

[git]
# Parse commits according to the conventional commits specification.
conventional_commits = true
# Include commits that do not match the conventional commits specification.
filter_unconventional = false
# Do not require all commits to be conventional.
require_conventional = false
# Split commits on newlines, treating each line as an individual commit.
split_commits = false
# Prevent breaking change commits from being excluded by parsers.
protect_breaking_commits = true
# Commit message preprocessors — run on raw commit text before parsing.
commit_preprocessors = [
    # Strip Claude session links from anywhere in the commit message.
    { pattern = '\s*https://claude\.ai/\S+', replace = "" },
    # Strip Co-Authored-By trailers (noise in changelog context).
    { pattern = '\nCo-Authored-By:.*', replace = "" },
    # Truncate to first line only — prevents multi-paragraph commit bodies
    # from flooding the changelog (especially older freeform commits).
    { pattern = '\n[\s\S]*', replace = "" },
    # Replace parenthesized issue/PR numbers with links: (#123) or (fixes #123).
    { pattern = '\((\w+\s)?#([0-9]+)\)', replace = "([#${2}](<REPO>/issues/${2}))" },
    # Replace bare issue/PR numbers with links: #123 (space-prefixed to avoid matching inside URLs/markdown).
    { pattern = ' #([0-9]+)', replace = " [#${1}](<REPO>/issues/${1})" },
]
# Commit parsers — maps conventional commit types to changelog sections.
# HTML comments (<!-- N -->) control section ordering and are stripped by the template.
# Breaking changes (feat!, fix!, BREAKING CHANGE footer) get their own top section.
commit_parsers = [
    { breaking = true, group = "<!-- 0 -->Breaking Changes" },
    { message = "^feat", group = "<!-- 1 -->Features" },
    { message = "^fix", group = "<!-- 2 -->Bug Fixes" },
    { message = "^refactor", group = "<!-- 3 -->Refactoring" },
    { message = "^perf", group = "<!-- 4 -->Performance" },
    { message = "^doc", group = "<!-- 5 -->Documentation" },
    { message = "^test", group = "<!-- 6 -->Testing" },
    { message = "^style", group = "<!-- 7 -->Styling" },
    { message = "^docs\\(release\\)", skip = true },
    { message = "^chore\\(release\\): prepare for", skip = true },
    { message = "^chore|^ci", group = "<!-- 8 -->Chores" },
    { message = "^revert", group = "<!-- 9 -->Reverted" },
    { message = ".*", group = "<!-- 10 -->Other" },
]
# Do not exclude commits unmatched by parsers.
filter_commits = false
# Do not fail on unmatched commits.
fail_on_unmatched_commit = false
# Link parsers for extracting external references.
link_parsers = [
    { pattern = "#(\\d+)", href = "<REPO>/issues/${1}" },
]
# Include only the tags that belong to the current branch.
use_branch_tags = false
# Order releases topologically instead of chronologically.
topo_order = false
# Order commits topologically instead of chronologically.
topo_order_commits = true
# Oldest commits first within each group (chronological reading order).
sort_commits = "oldest"
